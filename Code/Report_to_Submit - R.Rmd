---
title: "Report_to_submit_R"
author: "Ngoc Uyen PHUNG"
date: "2023-11-27"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
# Load the package
library(tidyverse)

library(readxl)
library(countrycode)
library(magrittr) # to use the pipe

# Visualization
library(hrbrthemes) # different themes for ggplot2 
library(paletteer)
library(plotly) # to have dynamic plot
```

```{r}
names_sort_count = function(data, decreasing=TRUE){
  return(
  data %>% 
    table() %>% 
    sort(decreasing = decreasing) %>% 
    names()
  )
}


```


```{r}
# Load the data
unicorn_data <- read_excel("../DataSets/CB-Insights_Global-Unicorn-Club_2023.xlsx")

```

```{r}
unicorn_data[duplicated(unicorn_data)==T, ]
```

## Cleaning the data

```{r pressure}
# Renaming Columns
colnames(unicorn_data) <- c('company','valuation_billions','date_added','country','city','industry','select_investors')


# Removing the duplicate company 
unicorn_data = unicorn_data %>% 
  distinct(company, .keep_all = T)


# Removing useless columns
unicorn_data = drop_na(unicorn_data, valuation_billions)


#Sequoia Capital firm name to avoid error when creating new df "unicorn_investors"
unicorn_data$select_investors <- gsub("and Sequoia Capital China", "Sequoia Capital China", unicorn_data$select_investors)


# Dealing with missing value in "country"
unicorn_data[538, "country"] <- "Singapore"

# Remove "City" column
unicorn_data <- subset(unicorn_data, select = -city)

# Removing ",," in "Select investors" correctly count  number of investors
unicorn_data$select_investors <- gsub(",,", ",", unicorn_data$select_investors)

# Removing all white spaces from "Select investors"

# Counting the number of Investors
unicorn_data$Number_of_Investors <- sapply(strsplit(as.character(unicorn_data$select_investors), ","), length)

# Replacing City names in the country variable
unicorn_data$country <- gsub("London", "United Kingdom", unicorn_data$country)
unicorn_data$country <- gsub("Munchen", "Germany", unicorn_data$country)

# continent Values
unicorn_data$continent = countrycode(sourcevar = unicorn_data$country,
                            origin = "country.name",
                            destination = "continent")

# Year Conversion 
unicorn_data$date_added = ymd(unicorn_data$date_added)

# Years since Joined
unicorn_data$age = interval(unicorn_data$date_added, now()) %/% years(1)

# Add column year
unicorn_data$year_added <- year(unicorn_data$date_added)

unicorn_data <- unicorn_data %>%
  mutate(target = 
           ifelse(valuation_billions >= 5, "Over 5 $B",  "Under 5 $B") %>% as.factor()) %>% 
  mutate(over_5bill = ifelse(target == "Over 5 $B", 1, 0))

unicorn_data %>% 
  arrange(industry, group_by = industry)

unicorn_data$industry = factor(unicorn_data$industry)

unicorn_data$continent = factor(unicorn_data$continent)

summary(unicorn_data)
```
## Transforming the Data

```{r}
# Creating an intermediary dataframe for later computations
unicorn_transition <- unicorn_data %>%
  mutate(select_investors = strsplit(select_investors, ",")) %>% 
  unnest(select_investors) %>% 
  mutate(select_investors = str_trim(select_investors)) 

# Creating the investors oriented dataframe for further analysis
unicorn_investors = unicorn_transition %>% 
  summarise(.by = select_investors,
            investements_count=n(),
            investements=list(company), 
            investements_sum_valuation=sum(valuation_billions),
            investements_mean_valuation=mean(valuation_billions), 
            investements_over5B_count=sum(over_5bill), 
            investements_over5B_pct=investements_over5B_count/investements_count
            )
  # group_by(company) %>%
  # distinct(associated_companies)

```


```{r}
investors_2 = investors %>% 
  unnest(investements_bis) %>% 
  unnest(investements) 

investors_3 = investors_2 %>% 
  subset(investements!=investements_bis)


investors_4 = investors_3 %>% 
  group_by(investements_bis) %>% 
  distinct(investements, .keep_all = T)
  

test = investors_3 %>% 
  group_by(investements_bis) %>% 
  mutate(duplicated(investements))

# Investor average percentage over 5B
associate_investor = unicorn_investors %>% 
  unnest(investements) %>% 
  summarise(.by = investements, 
            investements_avg_pct_over5B = mean(investements_over5B_pct)
            )
test_bis = test[test$`duplicated(investements)`==T,]

x = test[test$investements=="SingleStore",]
# Need to unlist + nesTt the Investements then delete the doubles in investements and find a way to delete the actual company inside
# drop rows that have the same company name in it


# Creating the associate companies trasition dataframe for later compuations 
associate_transition = unicorn_transition %>% 
  # Having two columns containing all the companies per Investor in a list
    summarise(.by = select_investors,
            associated_companies=list(company), 
            company=list(company)
            ) %>%
  # For each company we have their investors and a list of the companies 
  # the investors invested in. 
  unnest(company) %>% 
  # Unnesting the second column containg all the companies resulting in the 
  #duplication of all the other columns
  unnest(associated_companies) %>% 
  # Deleting the company name from the associated_company list
  # For each company, we will delete all the duplicates in the association company
  summarise(.by=company,
            associated_companies = unique(associated_companies)
            )

# Creating associate companies data frame with info regarding the associated companies
associate_companies = associate_transition %>% 
  # Deleting the company name from the associated_company list
  subset(company!=associated_companies) %>% 
  left_join(unicorn_data, by=join_by(associated_companies == company)) %>% 
  summarise(.by=company,
            associated_companies = list(unique(associated_companies)), 
            associated_count= n(),
            associated_count_over5Bill=sum(over_5bill), 
            associated_pct_over5Bill=associated_count_over5Bill/associated_count
            )
# Creating the associate valuation data frame with info regarding associate company valuation 

associate_valuation = associate_transition %>% 
  left_join(unicorn_data, by=join_by(associated_companies == company)) %>% 
  summarise(.by = company,
            association_total_value = sum(valuation_billions), 
            association_mean_value = mean(valuation_billions)
            )

unicorn_data_complete = unicorn_data %>% 
  left_join(associate_companies, by="company") %>% 
  left_join(associate_valuation, by="company") %>% 
  left_join(associate_investor, by=join_by(company == investements)) %>% 
  mutate(associated_count = ifelse(
    is.na(associated_count), 
    0, 
    associated_count
    )
  )

# unicorn_data_complete[is.na(unicorn_data_complete$associated_count),]

# unicorn_data_complete$associated_count = ifelse(
#   is.na(unicorn_data_complete$associated_count), 
#   0, 
#   unicorn_data_complete$associated_count
#   )


summary(unicorn_data_complete)


  # group_by(company) %>%
  # distinct(associated_companies)

```


```{r}

ggplot(unicorn_data, aes(x = industry)) +
  geom_bar(stat = "count", fill = "steelblue") +
  labs(title = "Distribution of the number of companies per industry") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlim(names_sort_count(unicorn_data$industry))

```

```{r}
ggplot(unicorn_data, aes(x = country)) +
  geom_bar(stat = "count", fill = "steelblue") +
  xlim(names_sort_count(unicorn_data$country))+
  labs(title = "Distribution of the number of companies per country") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
ggplot(unicorn_data, aes(x = continent)) +
  geom_bar(stat = "count", fill = "steelblue") +
  xlim(names_sort_count(unicorn_data$continent))+
  labs(title = "Distribution of the number of companies per country") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
ggplot(unicorn_data, aes(x = Number_of_Investors, fill = industry)) +
  geom_bar(stat = "count", position = "dodge") +
  labs(title = "Distribution of the number of investors")+
  scale_fill_paletteer_d("awtools::a_palette")
```

```{r pressure, echo=FALSE}
table1 <- table(unicorn_data$country, unicorn_data$target)
chiSqResult <- chisq.test(table1)
print(chiSqResult)


table2 <- table(unicorn_data$industry, unicorn_data$target)
chiSqResult <- chisq.test(table2)
print(chiSqResult)


table3 <- table(unicorn_data$continent, unicorn_data$target)
chiSqResult <- chisq.test(table3)
print(chiSqResult)


table4 <- table(unicorn_data$Number_of_Investors, unicorn_data$target)
chiSqResult <- chisq.test(table4)
print(chiSqResult)


table5 <- table(unicorn_data$Year_Joined, unicorn_data$target)
chiSqResult <- chisq.test(table5)
print(chiSqResult)


table6 <- table(unicorn_data$Age, unicorn_data$target)
chiSqResult <- chisq.test(table6)
print(chiSqResult)


```


