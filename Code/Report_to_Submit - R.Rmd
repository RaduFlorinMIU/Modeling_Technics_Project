---
title: "Report_to_submit_R"
author: "Ngoc Uyen PHUNG"
date: "2023-11-27"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
# Load the package
library(tidyverse)

library(readxl)
library(countrycode)
library(magrittr) # to use the pipe

# Visualization
library(hrbrthemes) # different themes for ggplot2 
library(paletteer)
library(plotly) # to have dynamic plot
```

```{r}
names_sort_count = function(data, decreasing=TRUE){
  return(
  data %>% 
    table() %>% 
    sort(decreasing = decreasing) %>% 
    names()
  )
}


```


```{r}
# Load the data
unicorn_data <- read_excel("../DataSets/CB-Insights_Global-Unicorn-Club_2023.xlsx")

```

## Cleaning the data

```{r pressure}
# Renaming Columns
colnames(unicorn_data) <- c('company','valuation_billions','date_added','country','city','industry','select_investors')

# Removing useless columns
unicorn_data = drop_na(unicorn_data, valuation_billions)


#Sequoia Capital firm name to avoid error when creating new df "unicorn_investors"
unicorn_data$select_investors <- gsub("and Sequoia Capital China", "Sequoia Capital China", unicorn_data$select_investors)


# Dealing with missing value in "country"
unicorn_data[538, "country"] <- "Singapore"

# Remove "City" column
unicorn_data <- subset(unicorn_data, select = -city)

# Removing ",," in "Select investors" correctly count  number of investors
unicorn_data$select_investors <- gsub(",,", ",", unicorn_data$select_investors)

# Removing all white spaces from "Select investors"

# Counting the number of Investors
unicorn_data$Number_of_Investors <- sapply(strsplit(as.character(unicorn_data$select_investors), ","), length)

# Replacing City names in the country variable
unicorn_data$country <- gsub("London", "United Kingdom", unicorn_data$country)
unicorn_data$country <- gsub("Munchen", "Germany", unicorn_data$country)

# continent Values
unicorn_data$continent = countrycode(sourcevar = unicorn_data$country,
                            origin = "country.name",
                            destination = "continent")

# Year Conversion 
unicorn_data$date_added = ymd(unicorn_data$date_added)

# Years since Joined
unicorn_data$age = interval(unicorn_data$date_added, now()) %/% years(1)

# Add column year
unicorn_data$year_added <- year(unicorn_data$date_added)

unicorn_data <- unicorn_data %>%
  mutate(target = 
           ifelse(valuation_billions >= 5, "Over 5 $B",  "Under 5 $B") %>% as.factor())

unicorn_data %>% 
  arrange(industry, group_by = industry)

unicorn_data$industry = factor(unicorn_data$industry)

unicorn_data$continent = factor(unicorn_data$continent)

summary(unicorn_data)
```
## Transforming the Data

```{r}
investors <- unicorn_data %>%
  mutate(select_investors = strsplit(select_investors, ",")) %>% 
  unnest(select_investors) %>% 
  mutate(select_investors = str_trim(select_investors))

investors = investors %>% 
  summarise(.by = select_investors,
            investements=list(company), 
            investements_bis=list(company)
            ) %>% 
  unnest(investements_bis) %>% 
  unnest(investements)

# Need to unlist + nest the Investements then delete the doubles in investements and find a way to delete the actual company inside
# drop rows that have the same company name in it

```



```{r}

ggplot(unicorn_data, aes(x = industry)) +
  geom_bar(stat = "count", fill = "steelblue") +
  labs(title = "Distribution of the number of companies per industry") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlim(names_sort_count(unicorn_data$industry))

```

```{r}
ggplot(unicorn_data, aes(x = country)) +
  geom_bar(stat = "count", fill = "steelblue") +
  xlim(names_sort_count(unicorn_data$country))+
  labs(title = "Distribution of the number of companies per country") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
ggplot(unicorn_data, aes(x = continent)) +
  geom_bar(stat = "count", fill = "steelblue") +
  xlim(names_sort_count(unicorn_data$continent))+
  labs(title = "Distribution of the number of companies per country") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
ggplot(unicorn_data, aes(x = Number_of_Investors, fill = industry)) +
  geom_bar(stat = "count", position = "dodge") +
  labs(title = "Distribution of the number of investors")+
  scale_fill_paletteer_d("awtools::a_palette")
```

```{r pressure, echo=FALSE}
table1 <- table(unicorn_data$country, unicorn_data$target)
chiSqResult <- chisq.test(table1)
print(chiSqResult)


table2 <- table(unicorn_data$industry, unicorn_data$target)
chiSqResult <- chisq.test(table2)
print(chiSqResult)


table3 <- table(unicorn_data$continent, unicorn_data$target)
chiSqResult <- chisq.test(table3)
print(chiSqResult)


table4 <- table(unicorn_data$Number_of_Investors, unicorn_data$target)
chiSqResult <- chisq.test(table4)
print(chiSqResult)


table5 <- table(unicorn_data$Year_Joined, unicorn_data$target)
chiSqResult <- chisq.test(table5)
print(chiSqResult)


table6 <- table(unicorn_data$Age, unicorn_data$target)
chiSqResult <- chisq.test(table6)
print(chiSqResult)


```


